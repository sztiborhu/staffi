# Database Design Document - Staffi
---

## 1. Áttekintés

### 1.1 Adatbázis típus és indoklás

A rendszer **PostgreSQL** relációs adatbázis-kezelőt használ.

* **Indoklás:** A HR és pénzügyi adatok (szerződések, előlegek) magas fokú tranzakcionális integritást (ACID) igényelnek. A PostgreSQL támogatja a komplex `CHECK` kényszereket és az automatikus ID generálást (`IDENTITY`), amelyek biztosítják az adatok konzisztenciáját adatbázis szinten is.

### 1.2 Tervezési elvek

* **Azonosítók:** Minden tábla `bigint` típusú, automatikusan növekvő `GENERATED BY DEFAULT AS IDENTITY` elsődleges kulcsot használ.
* **Időbélyegek:** Az események idejét `timestamp(6) without time zone` formátumban tároljuk.
* **Enumerációk:** A státuszokat `character varying(255)` mezők tárolják, amelyeket adatbázis szintű `CHECK` constraint-ek védenek az érvénytelen értékektől.
* **Pénzügyi pontosság:** Az összegeket (bér, előleg) `numeric(10,2)` típussal tároljuk a kerekítési hibák elkerülése érdekében.

---

## 2. Koncepcionális Modell

### 2.1 Entitás-Kapcsolat diagram (Logikai leírás)

A rendszer szíve a **User**, amely az autentikációért felel. Erre épül rá az **Employee** (dolgozói profil). A dolgozóhoz kapcsolódnak a **Contracts** (szerződések) és **Advance Requests** (előlegek). A szálláskezelés az **Accommodation -> Room -> Room Allocation** láncolaton keresztül kapcsolódik a dolgozóhoz. Minden módosítást az **Audit Log** rögzít.

### 2.2 Entitások leírása

* `users`: Rendszerfelhasználók (Admin, HR, Employee) adatai.
* `employees`: Munkavállaló-specifikus HR adatok (TAJ, Adóazonosító, okmányok).
* `accommodations`: Szálláshelyek (épületek) alapadatai.
* `rooms`: Szálláshelyekhez tartozó szobák és kapacitásuk.
* `room_allocations`: A dolgozók szobákhoz rendelése (beköltözés/kiköltözés).
* `contracts`: Munkaszerződések pénzügyi adatai és PDF elérhetősége.
* `advance_requests`: Előlegigénylések és azok bírálati státusza.
* `audit_logs`: Biztonsági és üzleti események naplója.

---

## 3. Logikai Modell (Séma specifikáció)

### 3.1 `accommodations` (Szálláshelyek)
Épületek és szállók törzsadatai.

| Oszlop | Típus | Kényszerek | Leírás |
| :--- | :--- | :--- | :--- |
| `id` | bigint | PK, Not Null | Szekvencia: `accommodations_id_seq` |
| `name` | varchar(100) | Not Null | Szálló neve |
| `address` | text | Not Null | Cím |
| `manager_contact` | varchar(100) | | Gondnok elérhetősége |
| `created_at` | timestamp(6) | | Létrehozás ideje |

### 3.2 `rooms` (Szobák)
Szobák definíciója egy szálláson belül.

| Oszlop | Típus | Kényszerek | Leírás |
| :--- | :--- | :--- | :--- |
| `id` | bigint | PK, Not Null | Szekvencia: `rooms_id_seq` |
| `accommodation_id`| bigint | FK, Not Null | Kapcsolat: `accommodations.id` |
| `room_number` | varchar(20) | Not Null | Szobaszám |
| `capacity` | integer | Not Null | Férőhelyek száma |

* **Egyedi kényszer:** `uk3hehhac1735rs4awfov3dac8l` (accommodation_id, room_number) - Egy szálláson belül a szobaszám egyedi.

### 3.3 `room_allocations` (Foglalások)
Munkavállalók elhelyezése szobákban.

| Oszlop | Típus | Kényszerek | Leírás |
| :--- | :--- | :--- | :--- |
| `id` | bigint | PK, Not Null | Szekvencia: `room_allocations_id_seq` |
| `room_id` | bigint | FK, Not Null | Kapcsolat: `rooms.id` |
| `employee_id` | bigint | FK, Not Null | Kapcsolat: `employees.id` |
| `check_in_date` | date | Not Null | Beköltözés dátuma |
| `check_out_date` | date | | Kiköltözés dátuma (NULL, ha aktív) |
| `status` | varchar(255) | Check | Foglalás státusza |
| `created_at` | timestamp(6) | | Rögzítés ideje |

* **Check Constraint:** `status` IN ('ACTIVE', 'CHECKED_OUT')

### 3.4 `users` (Felhasználók)
Központi felhasználói tábla (autentikáció).

| Oszlop | Típus | Kényszerek | Leírás |
| :--- | :--- | :--- | :--- |
| `id` | bigint | PK, Not Null | Szekvencia: `users_id_seq` |
| `email` | varchar(255) | Not Null | Belépési email |
| `password` | varchar(255) | Not Null | Jelszó hash |
| `first_name` | varchar(255) | Not Null | Keresztnév |
| `last_name` | varchar(255) | Not Null | Vezetéknév |
| `role` | varchar(255) | Not Null, Check | Szerepkör |
| `is_active` | boolean | Not Null | Fiók aktivitása |
| `created_at` | timestamp(6) | | |
| `updated_at` | timestamp(6) | | |

* **Check Constraint:** `role` IN ('EMPLOYEE', 'HR', 'ADMIN')

### 3.5 `employees` (Munkavállalók)
A User entitás kiegészítése HR adatokkal.

| Oszlop | Típus | Kényszerek | Leírás |
| :--- | :--- | :--- | :--- |
| `id` | bigint | PK, Not Null | Szekvencia: `employees_id_seq` |
| `user_id` | bigint | FK, Not Null | Kapcsolat: `users.id` |
| `tax_id` | varchar(20) | | Adóazonosító |
| `taj_number` | varchar(20) | | TAJ szám |
| `id_card_number` | varchar(20) | | Személyi igazolvány |
| `primary_address` | text | | Lakcím |
| `phone_number` | varchar(20) | | Telefonszám |
| `nationality` | varchar(50) | | Állampolgárság |
| `birth_date` | date | | Születési idő |
| `start_date` | date | | Munkaviszony kezdete |
| `company_name` | varchar(200) | | Munkáltató cég neve |

### 3.6 `contracts` (Szerződések)
Munkaszerződések nyilvántartása.

| Oszlop | Típus | Kényszerek | Leírás |
| :--- | :--- | :--- | :--- |
| `id` | bigint | PK, Not Null | Szekvencia: `contracts_id_seq` |
| `employee_id` | bigint | FK, Not Null | Kapcsolat: `employees.id` |
| `contract_number`| varchar(255) | Unique, Not Null| Szerződésszám |
| `status` | varchar(255) | Check | Státusz |
| `start_date` | date | Not Null | Kezdés dátuma |
| `end_date` | date | | Lejárat dátuma |
| `hourly_rate` | numeric(10,2)| Not Null | Órabér |
| `currency` | varchar(3) | | Pénznem |
| `pdf_path` | varchar(255) | | Generált fájl helye |
| `working_hours...`| integer | | Heti óraszám |
| `created_at` | timestamp(6) | | |

* **Check Constraint:** `status` IN ('EXPIRED', 'TERMINATED', 'ACTIVE', 'DRAFT')
* **Egyedi kényszer:** `ukbx9jyu2cccdntb3ehrf0ojpfd` (contract_number)

### 3.7 `advance_requests` (Előlegek)
Pénzügyi igénylések.

| Oszlop | Típus | Kényszerek | Leírás |
| :--- | :--- | :--- | :--- |
| `id` | bigint | PK, Not Null | Szekvencia: `advance_requests_id_seq` |
| `employee_id` | bigint | FK, Not Null | Igénylő (`employees.id`) |
| `amount` | numeric(10,2)| Not Null | Összeg |
| `reason` | text | | Indoklás |
| `status` | varchar(255) | Check | Állapot |
| `reviewed_by` | bigint | FK | Jóváhagyó (`users.id`) |
| `rejection_reason`| text | | Elutasítás oka |
| `request_date` | timestamp(6) | | Igénylés ideje |
| `reviewed_at` | timestamp(6) | | Bírálat ideje |

* **Check Constraint:** `status` IN ('PENDING', 'APPROVED', 'REJECTED', 'PAID')

### 3.8 `audit_logs` (Naplózás)
Rendszerbiztonsági napló.

| Oszlop | Típus | Kényszerek | Leírás |
| :--- | :--- | :--- | :--- |
| `id` | bigint | PK, Not Null | Szekvencia: `audit_logs_id_seq` |
| `action` | varchar(20) | Not Null, Check | Művelet típusa |
| `entity_type` | varchar(100) | Not Null | Érintett entitás |
| `entity_id` | bigint | | Entitás ID |
| `user_id` | bigint | | Felhasználó ID |
| `timestamp` | timestamp(6) | Not Null | Esemény ideje |
| `description` | text | | Leírás |
| `ip_address` | varchar(45) | | IP cím |
| `old_value` | text | | Régi érték |
| `new_value` | text | | Új érték |

* **Check Constraint:** `action` IN ('CREATE', 'UPDATE', 'DELETE', 'LOGIN', 'LOGOUT')

### 3.9 Kapcsolatok és kardinalitások

* `users (1) --- (1) employees` (1:1 kapcsolat a dolgozói profilhoz).
* `accommodations (1) --- (N) rooms` (Egy szálláson sok szoba).
* `rooms (1) --- (N) room_allocations` (Egy szobának sok foglalása lehet az időben).
* `employees (1) --- (N) contracts` (Egy dolgozónak több szerződése is lehet).

### 3.10 Megszorítások (Constraints)

* **Egyedi indexek (Unique):**
* `rooms`: `accommodation_id` + `room_number` párosnak egyedinek kell lennie.
* `contracts`: `contract_number` globálisan egyedi.


* **Státusz ellenőrzések (Check):**
* `advance_requests`: PENDING, APPROVED, REJECTED, PAID.
* `audit_logs`: CREATE, UPDATE, DELETE, LOGIN, LOGOUT.



---

## 4. Fizikai Modell

### 4.1 Indexelési stratégia

Az SQL séma alapján az alábbi dedikált indexek biztosítják a gyors keresést az `audit_logs` táblában:

* `idx_action`: Művelet típusa szerint.
* `idx_user_id`: Felhasználói tevékenység követése.
* `idx_timestamp`: Időrendi lekérdezésekhez.
* `idx_entity_id` & `idx_entity_type`: Adott rekord változástörténetéhez.

### 4.2 Szekvenciák

Minden tábla saját szekvenciát használ az ID generáláshoz (pl. `public.users_id_seq`).

---

## 5. Adatszótár

* **Identity:** PostgreSQL 10+ szabványú automatikus kulcsgenerálás.
* **FK (Foreign Key):** Idegen kulcs, amely biztosítja a referenciális integritást.
* **Audit Trail:** Az `audit_logs` tábla által biztosított eseménysor, amely visszakövethetővé teszi a rendszer változásait.

---

## 6. Séma Verziókezelés

### 6.1 Migráció stratégia

Jelenleg a rendszer a Hibernate `ddl-auto: update` funkcióját használja fejlesztéshez.
**Javaslat:** Éles környezetben (Production) kötelező áttérni a Flyway vagy Liquibase használatára, ahol a megadott SQL dump képezi a `V1__init.sql` alapot.

---

## 7. Adatintegritás és Validáció

Az adatbázis kényszeríti:

1. **Referenciális integritás:** Nem törölhető dolgozó, amíg aktív szerződése vagy szállásfoglalása van.
2. **Domain integritás:** A `status` mezők csak az előre definiált értékeket vehetik fel (CHECK constraints).

---

## 8. Teszt és Seed Adatok

A megadott SQL dump alapján a rendszer már tartalmaz kezdeti adatokat:

* **Users:** Aktuális utolsó ID: 8.
* **Employees:** Aktuális utolsó ID: 7.
* **Audit Logs:** 86 bejegyzés már létezik.
* **Minta Szállás:** "Munkásszálló A épület" (ID: 1) rögzítve.